@{
    Layout = null;
}

<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Preset Tuner</title>
    <style type="text/css">
        body {
            background-color: black;
            color: white;
            font-family: sans-serif;
            font-size: 16pt;
            text-align: center;
        }

        audio {
            width: 400px;
            max-width: calc(100vw - 50px);
            visibility: hidden;
        }

        a {
            color: inherit;
        }

        button, input, select {
            font-size: inherit;
        }

        table {
            border-collapse: collapse;
            margin: auto;
            text-align: center;
        }

        td, th {
            padding: 0.5em;
        }

        input[type=checkbox] {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <audio controls></audio>
    <hr />
    @{
        var bookmarks = BookmarkManager.getBookmarks();
        var channels = SiriusXMChannelProvider.channels.OrderBy(c => bookmarks.Contains(c.id) ? 1 : 2);
    }
    <form asp-action="PlayChannel" method="get" id="playByNumber">
        <input type="number"
               name="num"
               min="@channels.Select(c => c.number).Min()"
               max="@channels.Select(c => c.number).Max()"
               step="1"
               style="min-width: 100px"
               value="@channels.First().number" />
        <button type="submit">
            Play
        </button>
    </form>
    <hr />
    <form asp-action="SetBookmarks">
        <table style="">
            <tbody>
                @foreach (var channel in channels)
                {
                    <tr>
                        <td>
                            @if (bookmarks.Contains(channel.id))
                            {
                                <input type="checkbox" name="id" value="@channel.id" checked />
                            }
                            else
                            {
                                <input type="checkbox" name="id" value="@channel.id" />
                            }
                        </td>
                        <td style="text-align: right">
                            @channel.number
                        </td>
                        <td style="text-align: left">
                            <a href="http://@(NetworkInterfaceProvider.address):5000/Proxy/@(channel.id).m3u8" class="button play">
                                @channel.name
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <p>
            <button type="submit">
                Save bookmarks
            </button>
        </p>
    </form>
    <hr />
    <div>
        <a href="http://@(NetworkInterfaceProvider.address):9000" class="button">
            Lyrion Music Server
        </a>
    </div>
    <hr />
    <details>
        <summary>Administration</summary>
        <div style="margin: 1em">
            <form asp-action="RefreshChannels">
                <p>
                    <button type="submit">
                        Refresh SiriusXM channel list
                    </button>
                </p>
            </form>
            <form asp-action="UpdateIPAddress">
                <p>
                    <button type="submit">
                        Update IP address
                    </button>
                </p>
            </form>
            <form asp-action="SetCredentials">
                <p>
                    <label>
                        Username
                        <input name="username" type="text" />
                    </label>
                </p>
                <p>
                    <label>
                        Password
                        <input name="password" type="password" />
                    </label>
                </p>
                <p>
                    <button type="submit">Update SiriusXM credentials</button>
                </p>
            </form>
        </div>
    </details>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.5.18/hls.min.js"
            integrity="sha512-hARxLWym80kd0Bzl5/93OuW1ujaKfvmJ90yTKak/RB67JuNIjtErU2H7H3bteyfzMuqiSK0tXarT7eK6lEWBBA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"></script>
    <script type="text/javascript">
        (async () => {
            try {
                if (Hls.isSupported()) {
                    const audio = document.getElementsByTagName("audio")[0];

                    const hls = new Hls({ startPosition: 0 });

                    const pr = new Promise(r => hls.on(Hls.Events.MEDIA_ATTACHED, r));
                    hls.attachMedia(audio);
                    await pr;

                    const play = async (url) => {
                        audio.pause();

                        hls.loadSource(url);

                        await new Promise(r => hls.on(Hls.Events.MANIFEST_PARSED, r));

                        audio.style.visibility = "visible";
                        audio.play();
                    };

                    document.getElementById("playByNumber").addEventListener("submit", e => {
                        e.preventDefault();
                        const number = e.target.querySelector("input[type=number]").value;
                        play(`/Home/PlayChannel?num=${number}`);
                    });

                    for (const playButton of document.querySelectorAll(".button.play")) {
                        playButton.addEventListener("click", e => {
                            e.preventDefault();
                            play(e.target.href);
                        })
                    }

                    hls.on(Hls.Events.ERROR, function (event, data) {
                        console.warn(event, data);
                    });
                }
            } catch (e) {
                console.error(e);
            }
        })();
    </script>
</body>
</html>
